# 定时任务功能说明

## 🎯 功能概述

每个搜索任务创建后会自动启动定时执行，**每60秒**自动搜索一次最新的票务信息，直到：
- 用户手动停止
- 用户手动暂停
- 用户关闭浏览器（后台继续运行）

## ✨ 核心特性

### 1. 自动定时搜索
- **间隔时间**：60秒
- **自动执行**：任务创建后立即开始，之后每60秒执行一次
- **持久化运行**：即使关闭浏览器，后台任务继续运行
- **智能去重**：自动跳过已存在的票务信息

### 2. 任务状态管理
- **running**：正在运行中，定时任务活跃
- **paused**：已暂停，定时任务暂停但不删除
- **stopped**：已停止，定时任务已删除
- **completed**：已完成（旧状态，新任务不再使用）

### 3. 实时信息显示
每个任务显示以下信息：
- 执行次数（run_count）
- 上次执行时间（last_run_at）
- 下次执行时间（next_run_at）
- 当前状态消息（message）

## 🚀 使用方法

### 创建定时任务
1. 在搜索框输入关键词
2. 点击"开始搜索"
3. 任务自动创建并启动定时执行

### 暂停任务
```
POST /tasks/{task_id}/pause
```
- 暂停定时执行，但保留任务和调度配置
- 可以随时恢复

### 恢复任务
```
POST /tasks/{task_id}/resume
```
- 恢复之前暂停的任务
- 继续按原定时间间隔执行

### 停止任务
```
POST /tasks/{task_id}/stop
```
- 完全停止并移除定时任务
- 无法恢复，只能重新创建

### 删除任务
```
POST /tasks/{task_id}/delete
```
- 删除任务及其相关的票务数据
- 自动停止定时任务

## 📊 数据库结构

### WorkflowExecution 表新增字段

| 字段名 | 类型 | 说明 |
|--------|------|------|
| message | String(255) | 状态消息 |
| is_scheduled | Boolean | 是否启用定时任务 |
| schedule_interval | Integer | 定时间隔（秒） |
| last_run_at | DateTime | 上次执行时间 |
| next_run_at | DateTime | 下次执行时间 |
| run_count | Integer | 执行次数 |

## 🔧 技术实现

### 后端架构

1. **Monitor 类**
   - 管理所有定时任务
   - 使用 APScheduler 实现调度
   - 支持任务的添加、暂停、恢复、删除

2. **execute_scheduled_task()**
   - 定时任务执行函数
   - 自动调用关键词优化
   - 并发处理搜索结果（5线程）
   - 实时推送结果到前端

3. **任务持久化**
   - 应用启动时自动恢复活跃任务
   - 数据库记录所有执行信息
   - SSE 实时推送状态更新

### API 端点

| 端点 | 方法 | 说明 |
|------|------|------|
| /search | POST | 创建新任务（自动启动定时） |
| /tasks | GET | 获取任务列表（包含定时信息） |
| /tasks/{id}/pause | POST | 暂停任务 |
| /tasks/{id}/resume | POST | 恢复任务 |
| /tasks/{id}/stop | POST | 停止任务 |
| /tasks/{id}/delete | POST | 删除任务 |

## 📱 前端集成（待实现）

### 任务卡片需要显示
```javascript
{
  id: 1,
  msg: "周杰伦演唱会",
  status: "running",
  message: "第 3 次执行完成，发现 2 条新票务",
  run_count: 3,
  last_run_at: "2025-10-24 15:55:30",
  next_run_at: "2025-10-24 15:56:30",
  is_scheduled: true,
  schedule_interval: 60
}
```

### 任务操作按钮
- **running 状态**：显示"暂停"和"停止"按钮
- **paused 状态**：显示"恢复"和"停止"按钮  
- **stopped 状态**：仅显示"删除"按钮

### 倒计时显示
计算并显示距离下次执行的剩余时间：
```javascript
const now = new Date();
const nextRun = new Date(task.next_run_at);
const seconds = Math.max(0, Math.floor((nextRun - now) / 1000));
// 显示：还剩 45 秒
```

## 🔍 工作流程

### 任务创建流程
```
用户输入关键词
    ↓
优化关键词 (AI)
    ↓
创建 WorkflowExecution 记录
    ↓
添加定时任务 (60秒间隔)
    ↓
立即执行首次搜索
    ↓
后台持续定时执行
```

### 定时执行流程
```
触发定时任务
    ↓
检查任务状态
    ↓
更新执行信息 (run_count, last_run_at, next_run_at)
    ↓
通知前端状态更新
    ↓
优化关键词
    ↓
调用小红书 MCP 服务
    ↓
并发分析笔记内容 (5线程)
    ↓
保存新票务信息
    ↓
实时推送到前端
    ↓
等待下次执行（60秒后）
```

## ⚠️ 注意事项

1. **资源消耗**
   - 每个活跃任务每60秒执行一次
   - 建议不要同时运行超过10个任务
   - 及时停止不需要的任务

2. **数据去重**
   - 系统自动跳过已存在的笔记
   - 只保存新发现的票务信息
   - 避免数据库膨胀

3. **应用重启**
   - 重启后自动恢复所有 running 状态的任务
   - 保持原有的定时间隔
   - 不会重复发送已有的数据

4. **浏览器关闭**
   - 关闭浏览器不影响后台任务执行
   - 重新打开浏览器后可继续查看结果
   - SSE 会自动重连

## 🎨 前端UI建议

### 任务卡片设计
```
┌─────────────────────────────────────┐
│ 📍 周杰伦演唱会                     │
│ ⏱️  第 5 次执行 • 还剩 23 秒        │
│ 📊 上次: 15:55:30 • 下次: 15:56:30 │
│                                     │
│ [⏸️ 暂停]  [⏹️ 停止]  [🗑️ 删除]    │
└─────────────────────────────────────┘
```

### 状态图标
- 🟢 running - 绿色，运行中
- 🟡 paused - 黄色，已暂停
- 🔴 stopped - 红色，已停止

## 📝 下一步

1. ✅ 后端定时任务功能已完成
2. ⏳ 前端UI需要更新：
   - 显示执行次数和时间
   - 添加暂停/恢复按钮
   - 显示倒计时
   - 状态图标和提示
3. ⏳ 可选优化：
   - 支持自定义时间间隔
   - 任务执行历史记录
   - 执行成功率统计
   - 邮件/推送通知

---

**当前状态**: 后端功能已完成，数据库已更新，应用已启动
**访问地址**: http://localhost:8888
**下一步**: 更新前端页面以支持新功能
